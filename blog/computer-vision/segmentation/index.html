<!DOCTYPE html>
<html lang="en">
<head>
  <title>Segmentation and Detection – Lucas David</title>
  <meta charset="utf-8" />
<meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
<meta http-equiv='X-UA-Compatible' content='IE=edge'>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="image_src" type="image/png" href="img_path" />


<meta name="description" content="A comparison between edge-based segmentation, Felzenszwalb's method and morphological segmentation." />
<meta property="og:description" content="A comparison between edge-based segmentation, Felzenszwalb's method and morphological segmentation." />
<meta property="og:image" content="" />

<meta name="author" content="Lucas David" />


<meta property="og:title" content="Segmentation and Detection" />
<meta property="twitter:title" content="Segmentation and Detection" />


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<link rel="alternate" type="application/rss+xml" title="Lucas David - my personal website/blog"
      href="/feed.xml" />

  
  
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-LG7FZ8VCHM"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-LG7FZ8VCHM');
	</script>


  
  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="/style.css" />

</head>
<body>
  <nav id="mainNav" class="navbar navbar-light bg-white navbar-expand-lg d-print-none border-bottom border-light ">
  <div class="container-xl">
    <button class="navbar-toggler rounded-0 border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo01"
      aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <a class="navbar-brand fw-bold text-decoration-none p-1" href="/">Lucas David</a>

    <div class="collapse navbar-collapse" id="navbarTogglerDemo01">

      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
      </ul>
      <span class="navbar-text navbar-excerpt">
        Segmentation and Detection
      </span>
      <span class="navbar-text font-small ms-2 me-2 sr-none" aria-hidden="true">•</span>
      <ul class="navbar-nav mb-2 mb-lg-0 font-small">
        <li class="nav-item"><a href="/" class="nav-link fw-bold link-dark fs-6">Home</a></li>
        <li class="nav-item"><a href="/blog" class="nav-link fw-bold link-dark fs-6">Blog</a></li>
        <li class="nav-item"><a href="/publications" class="nav-link fw-bold link-dark fs-6">Publications</a></li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle fw-bold link-dark fs-6" href="#" id="nbd-links-social" role="button"
            data-bs-toggle="dropdown" aria-expanded="false">
            Social
          </a>
          <ul class="dropdown-menu font-small dropdown-menu-end" aria-labelledby="nbd-links-social">
            <li><a class="dropdown-item text-decoration-none" target="_blank"
                href="https://github.com/lucasdavid">
                <i aria-label="GitHub" class="bi bi-github link-dark sr-none"></i>
                Github</a></li>
            <li><a class="dropdown-item text-decoration-none" target="_blank"
                href="https://www.linkedin.com/in/ld7">
                <i class="bi bi-linkedin text-primary sr-none"></i>
                Linkedin</a></li>

            <li itemscope itemtype="https://schema.org/Person">
              <a itemprop="sameAs" content="https://orcid.org/0000-0002-8793-7300" href="https://orcid.org/0000-0002-8793-7300"
                  target="orcid.widget"
                  rel="me noopener noreferrer"
                  class="dropdown-item text-decoration-none"
                >
                <img src="/assets/images/infra/32px-ORCID_iD.webp" alt="ORCID logo" class="sr-none" style="margin-bottom: 5px; width: 16px;">
                ORCID</a>
            </li>

            <li><a class="dropdown-item text-decoration-none" target="_blank"
                href="http://stackoverflow.com/users/2429640/lucasdavid">
                <i class="bi bi-code-slash link-dark sr-none"></i>
                Stackoverflow</a></li>
            <li><a class="dropdown-item text-decoration-none" target="_blank"
                href="https://youtube.com/channel/UC7IWeKUy4OSlC5ripcQGD6Q">
                <i class="bi bi-youtube text-danger sr-none"></i>
                Youtube</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

  <div class="empty-v-space d-none d-xl-block" style="margin-bottom: 5vh"></div>
</div>
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12 col-xl-3 col-xxl-2 offset-xxl-1">
      <div id="sidebar" class="">
  <div class="text-center">
    <a href="/" title="Home">
      <img src="/assets/images/infra/aloy-100.png" alt="Aloy, a character from Horizon Zero Dawn."
        class="img-fluid rounded-circle" style="width:100px" />
    </a>
    <p class="pt-2 font-small">
      
        <a href="mailto:mb37410l3@mozmail.com" class="text-decoration-none fw-bold">mb37410l3@mozmail.com</a>
      
    </p>
  </div>

  
</div>

    </div>
    <div id="table-of-contents-container-r" class="col-12 col-xl-3 col-xxl-2 order-xl-2">
      
      <div style="z-index: 0; font-size:0.8rem;">
        <div id="table-of-contents" class="font-small">
  <p class="border-bottom"><strong>Summary</strong></p>
  <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#segmentation-and-detection-of-simple-geometric-shapes">Segmentation and Detection of Simple Geometric Shapes</a>
<ul>
<li class="toc-entry toc-h3"><a href="#edge-based-segmentation">Edge-Based Segmentation</a></li>
<li class="toc-entry toc-h3"><a href="#segmentation-using-felzenszwalbs-method">Segmentation using Felzenszwalb’s Method</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#bccd-dataset">BCCD Dataset</a>
<ul>
<li class="toc-entry toc-h3"><a href="#segmentation-using-felzenszwalbs-method-1">Segmentation using Felzenszwalb’s Method</a></li>
<li class="toc-entry toc-h3"><a href="#morphological-boundaries">Morphological Boundaries</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#references">References</a></li>
</ul>
</div>

      </div>
      
    </div>
    <div class="col-12 col-xl-6">
      <article class="post mb-4">
        <header class="">
          <h1 id="postTitle" class="fw-bold">Segmentation and Detection</h1>
          <p class="right-align mb-2 text-muted fs-5">
            A comparison between edge-based segmentation, Felzenszwalb's method and morphological segmentation. <em>— July 16, 2021</em>
          </p>
          <div class="mb-4">
            <span class="badges-container">
  
    <a href="/blog/tag/computer-vision"
       class="btn badge rounded-pill btn-dark text-bg-dark text-decoration-none"
       style="font-size: 0.8em;"
       type="button"
       role="button"
       >Computer Vision</a>
  
    <a href="/blog/tag/segmentation"
       class="btn badge rounded-pill btn-dark text-bg-dark text-decoration-none"
       style="font-size: 0.8em;"
       type="button"
       role="button"
       >Segmentation</a>
  
</span>

          </div>
        </header>
        <div class="article-content" style="margin-top: 4rem;">
          <p><span class="fs-1" style="line-height:0">F</span>ollowing the pattern of my previous posts,
this one is based on an assignment submitted to the class of 2021/1 of course
Introduction to Image Processing (MO443) at Universidade Estadual de Campinas.
Its goal is to apply segmentation algorithms over images and extract characteristics of the objects using
Python programming language and assess its results.</p>

<div class="text-center mb-1" style="height:1.25rem">
  <hr class="thin mb-0 border-1 sr-none " />
  <button data-bs-target="#csetup" aria-controls="csetup" class="btn rounded-5 btn-light" style="position: relative; margin-top: -2rem;" type="button" data-bs-toggle="collapse" aria-expanded="false">show setup code</button>
</div>

<div class="language-python collapse highlighter-rouge" id="csetup"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span> <span class="k">as</span> <span class="n">ftpartial</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">skimage.io</span>
<span class="kn">import</span> <span class="nn">skimage.filters</span>
<span class="kn">import</span> <span class="nn">skimage.feature</span>
<span class="kn">import</span> <span class="nn">skimage.segmentation</span>

<span class="kn">from</span> <span class="nn">skimage.color</span> <span class="kn">import</span> <span class="n">label2rgb</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>

<span class="n">sns</span><span class="p">.</span><span class="nb">set</span><span class="p">()</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s">"Set3"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">partial_func</span> <span class="o">=</span> <span class="n">ftpartial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">partial_func</span><span class="p">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">func</span><span class="p">.</span><span class="n">__name__</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span><span class="si">}</span><span class="s">"</span>
                             <span class="sa">f</span><span class="s">" </span><span class="si">{</span><span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">((</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="o">=</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s">' for a, b in kwargs.items()))</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">partial_func</span>

<span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span>
    <span class="n">image</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">cols</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># many images
</span>            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span> <span class="ow">or</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="o">/</span> <span class="n">rows</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">)):</span>
                <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">visualize</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span>
                          <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ix</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">fig</span>

        <span class="k">if</span> <span class="n">image</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[...,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_segments</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span> <span class="ow">or</span> <span class="n">plt</span><span class="p">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">label2rgb</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">bg_label</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">C</span><span class="p">,</span> <span class="n">bg_color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">p</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">minr</span><span class="p">,</span> <span class="n">minc</span><span class="p">,</span> <span class="n">maxr</span><span class="p">,</span> <span class="n">maxc</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="s">'bbox-0'</span><span class="p">],</span> <span class="n">region</span><span class="p">[</span><span class="s">'bbox-1'</span><span class="p">],</span> <span class="n">region</span><span class="p">[</span><span class="s">'bbox-2'</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="s">'bbox-3'</span><span class="p">]</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">minc</span><span class="p">,</span> <span class="n">minr</span><span class="p">),</span> <span class="n">maxc</span> <span class="o">-</span> <span class="n">minc</span><span class="p">,</span> <span class="n">maxr</span> <span class="o">-</span> <span class="n">minr</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                             <span class="n">edgecolor</span><span class="o">=</span><span class="n">C</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>

        <span class="n">plt</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">region</span><span class="p">[</span><span class="s">'centroid-1'</span><span class="p">],</span> <span class="n">region</span><span class="p">[</span><span class="s">'centroid-0'</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">region</span><span class="p">.</span><span class="n">label</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">plot_detection_boxes</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s">'image'</span><span class="p">].</span><span class="n">shape</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s">'objects'</span><span class="p">][</span><span class="s">'bbox'</span><span class="p">].</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s">'objects'</span><span class="p">][</span><span class="s">'label'</span><span class="p">].</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bboxes</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">minr</span><span class="p">,</span> <span class="n">minc</span><span class="p">,</span> <span class="n">maxr</span><span class="p">,</span> <span class="n">maxc</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">minr</span><span class="p">,</span> <span class="n">minc</span><span class="p">,</span> <span class="n">maxr</span><span class="p">,</span> <span class="n">maxc</span> <span class="o">=</span> <span class="n">minr</span><span class="o">*</span><span class="n">H</span><span class="p">,</span> <span class="n">minc</span><span class="o">*</span><span class="n">W</span><span class="p">,</span> <span class="n">maxr</span><span class="o">*</span><span class="n">H</span><span class="p">,</span> <span class="n">maxc</span><span class="o">*</span><span class="n">W</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">minc</span><span class="p">,</span> <span class="n">minr</span><span class="p">),</span> <span class="n">maxc</span> <span class="o">-</span> <span class="n">minc</span><span class="p">,</span> <span class="n">maxr</span> <span class="o">-</span> <span class="n">minr</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                             <span class="n">edgecolor</span><span class="o">=</span><span class="n">C</span><span class="p">[</span><span class="n">l</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">C</span><span class="p">)],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">minc</span><span class="p">,</span><span class="n">minr</span><span class="p">,</span> <span class="n">int2str</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
</code></pre></div></div>

<h2 id="segmentation-and-detection-of-simple-geometric-shapes">Segmentation and Detection of Simple Geometric Shapes</h2>

<p>Using scikit-image, multiple segmentation strategies are available.
For instance, one can extract borders <a class="citation" href="#torre4767769">[1]</a> and label the connected regions;
or find central regions and apply label expansion methods such as Watershed <a class="citation" href="#strahler1957quantitative">[2]</a>.</p>

<p>In the following sections, we exemplify two strategies (edge-based segmentation and the Felzenszwalb’s method)
over simple geometric shapes, illustrated in the figure below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">image_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">Config</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">path</span><span class="p">))</span>
<span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">skimage</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">Config</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">]</span>
<span class="n">grays</span> <span class="o">=</span> <span class="p">[</span><span class="n">skimage</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">rgb2gray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

<span class="n">visualize</span><span class="p">([</span><span class="o">*</span><span class="n">images</span><span class="p">,</span> <span class="o">*</span><span class="n">grays</span><span class="p">],</span> <span class="n">image_files</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">);</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_7_0.webp" alt="Simple colored geometric shapes." class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Simple colored geometric shapes.
  </figcaption>


  </figure>
</div>

<h3 id="edge-based-segmentation">Edge-Based Segmentation</h3>

<p>Scikit-image implements many of the border extraction methods available in the literature, such as Sobel, Prewitt and Scharr <a class="citation" href="#torre4767769">[1]</a>.
The can be trivially used as described below.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">methods</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">skimage</span><span class="p">.</span><span class="n">filters</span><span class="p">.</span><span class="n">sobel</span><span class="p">,</span>
  <span class="n">skimage</span><span class="p">.</span><span class="n">filters</span><span class="p">.</span><span class="n">roberts</span><span class="p">,</span>
  <span class="n">skimage</span><span class="p">.</span><span class="n">filters</span><span class="p">.</span><span class="n">prewitt</span><span class="p">,</span>
  <span class="n">skimage</span><span class="p">.</span><span class="n">filters</span><span class="p">.</span><span class="n">farid</span><span class="p">,</span>
  <span class="n">skimage</span><span class="p">.</span><span class="n">filters</span><span class="p">.</span><span class="n">scharr</span><span class="p">,</span>
  <span class="n">partial</span><span class="p">(</span><span class="n">skimage</span><span class="p">.</span><span class="n">feature</span><span class="p">.</span><span class="n">canny</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.</span><span class="p">),</span>
  <span class="n">partial</span><span class="p">(</span><span class="n">skimage</span><span class="p">.</span><span class="n">feature</span><span class="p">.</span><span class="n">canny</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
  <span class="n">partial</span><span class="p">(</span><span class="n">skimage</span><span class="p">.</span><span class="n">feature</span><span class="p">.</span><span class="n">canny</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">segments</span> <span class="o">=</span> <span class="p">[[</span><span class="n">m</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grays</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">]</span>
</code></pre></div></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU <span class="nb">times</span>: user 381 ms, sys: 4.75 ms, total: 386 ms
Wall <span class="nb">time</span>: 389 ms
</code></pre></div></div>

<div class="text-center mb-1" style="height:1.25rem">
  <hr class="thin mb-0 border-1 sr-none " />
  <button data-bs-target="#cv1" aria-controls="cv1" class="btn rounded-5 btn-light" style="position: relative; margin-top: -2rem;" type="button" data-bs-toggle="collapse" aria-expanded="false">show collapsed</button>
</div>

<div class="language-python collapse highlighter-rouge" id="cv1"><div class="highlight"><pre class="highlight"><code><span class="n">method_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">__name__</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">]</span>

<span class="n">visualize</span><span class="p">(</span><span class="n">grays</span><span class="p">,</span> <span class="n">image_files</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">);</span>

<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">method_names</span><span class="p">,</span> <span class="n">segments</span><span class="p">):</span>
  <span class="n">visualize</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray_r'</span><span class="p">);</span>
</code></pre></div></div>

<div id="carouselBorders" class="carousel slide carousel-dark" data-bs-ride="carousel" alt="Results from multiple border extraction methods over images containing simple geometric shapes.">
  <div class="carousel-inner">
    <div class="carousel-item active"><img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_10_1.webp" class="d-block w-100" /></div>
    <div class="carousel-item"><img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_10_2.webp" class="d-block w-100" /></div>
    <div class="carousel-item"><img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_10_3.webp" class="d-block w-100" /></div>
    <div class="carousel-item"><img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_10_4.webp" class="d-block w-100" /></div>
    <div class="carousel-item"><img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_10_5.webp" class="d-block w-100" /></div>
    <div class="carousel-item"><img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_10_6.webp" class="d-block w-100" /></div>
    <div class="carousel-item"><img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_10_7.webp" class="d-block w-100" /></div>
    <div class="carousel-item"><img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_10_8.webp" class="d-block w-100" /></div>
  </div>
  <button class="carousel-control-prev" type="button" data-bs-target="#carouselBorders" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Previous</span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#carouselBorders" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Next</span>
  </button>
</div>

<p>The figure above contains a comparison between the available border extraction methods. Roberts seems to produce the thinnest borders amongst all methods, while Farid produces thicker ones. Sobel, Prewitt and Scharr have similar results. Finally, Canny with a small $\sigma$ parameter (used to set the standard deviation of the Gaussian filter) results in accurate borders for simple shapes. However, the original gray intensity of the object’s border is lost, with all borders presenting the same gray intensity. Canny with a very large sigma parameter ($\sigma=3$) still manages to extract borders from simple objects, though corners become round.</p>

<p>With closed borders in hands, extracted from one of the methods above,
we can simply fill the wholes to separate what’s background and foreground:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>

<span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">skimage</span><span class="p">.</span><span class="n">filters</span><span class="p">.</span><span class="n">roberts</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grays</span><span class="p">]</span>
<span class="n">filled</span> <span class="o">=</span> <span class="p">[</span><span class="n">ndimage</span><span class="p">.</span><span class="n">binary_fill_holes</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>

<span class="n">visualize</span><span class="p">(</span><span class="n">filled</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray_r'</span><span class="p">);</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_12_0.webp" alt="The figure displays three binary images, in which the geometric shapes are filled with the color black, and the background is shown in white." class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Binary filling of the borders previously extracted.
  </figcaption>


  </figure>
</div>

<p>Notice we used the color map <code class="language-plaintext highlighter-rouge">gray_r</code>, indicating objects were filled with the value <code class="language-plaintext highlighter-rouge">1</code> while the background is represented with the value <code class="language-plaintext highlighter-rouge">0</code>.
As each object is now represented by a distinct connected component, we can extract properties using functions in the <code class="language-plaintext highlighter-rouge">skimage.measure</code> module:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">label</span>
<span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">regionprops_table</span>

<span class="n">properties</span> <span class="o">=</span> <span class="p">(</span><span class="s">'label'</span><span class="p">,</span> <span class="s">'area'</span><span class="p">,</span> <span class="s">'convex_area'</span><span class="p">,</span> <span class="s">'eccentricity'</span><span class="p">,</span>
              <span class="s">'solidity'</span><span class="p">,</span> <span class="s">'perimeter'</span><span class="p">,</span> <span class="s">'centroid'</span><span class="p">,</span> <span class="s">'bbox'</span><span class="p">)</span>

<span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filled</span><span class="p">]</span>
<span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">))</span>
         <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>
</code></pre></div></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU <span class="nb">times</span>: user 129 ms, sys: 4.74 ms, total: 133 ms
Wall <span class="nb">time</span>: 137 ms
</code></pre></div></div>

<div class="text-center mb-1" style="height:1.25rem">
  <hr class="thin mb-0 border-1 sr-none " />
  <button data-bs-target="#cv2" aria-controls="cv2" class="btn rounded-5 btn-light" style="position: relative; margin-top: -2rem;" type="button" data-bs-toggle="collapse" aria-expanded="false">show collapsed</button>
</div>

<div class="language-python collapse highlighter-rouge" id="cv2"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_all_segments</span><span class="p">(</span><span class="n">grays</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
  <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">grays</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">props</span><span class="p">)):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plot_segments</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

  <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">grays</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">props</span><span class="p">)):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">hist</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
  <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plot_all_segments</span><span class="p">(</span><span class="n">grays</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
</code></pre></div></div>

<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_14_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Segmentation of the objects in the three original images using edge detection and binary fill of wholes. Segmentation maps are overlayed with objects, while the bounding boxes used to delimit each object was extracted as a property in <code>regionprops_table</code>.
  </figcaption>


  </figure>
</div>

<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_14_1.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Histograms of areas detected from objects in each input image.
  </figcaption>


  </figure>
</div>

<p>A simple way to count objects based on their overall area is to use histograms.
Fig. 5 illustrate this application over each image. In the first, forms are separated into two similar groups:
small(close to 500), and large (approx. 2,500).
A more diverse set of areas are present in the second image, producing a more disperse histogram.
In the last image, three objects have very large area (1, 3 and 8).
Object 6 has an intermediate size, while the remaining objects are small.</p>

<h3 id="segmentation-using-felzenszwalbs-method">Segmentation using Felzenszwalb’s Method</h3>

<p>This segmentation method was described in “Efficient graph-based image segmentation”, by Felzenszwalb et. al. <a class="citation" href="#felzenszwalb2004">[3]</a>
It consists of representing the pixel-color intensity in an image as a grid and find $N$ partitions representing similarity.
As the algorithm progresses, the closest partitions (with respect to a connection predicate) are iteratively merged.
The final number of partitions is minimum (optimal) while still respecting the connection predicate.</p>

<p>The following code exemplifies the application of Felzenszwalb’s segmentation method implemented in scikit-image over images:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">skimage</span><span class="p">.</span><span class="n">segmentation</span><span class="p">.</span><span class="n">felzenszwalb</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grays</span><span class="p">]</span>
<span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">Config</span><span class="p">.</span><span class="n">properties</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>

<span class="n">props</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">head</span><span class="p">().</span><span class="nb">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<div class="table-responsive"><table class="dataframe table table-hover">
  <thead>
    <tr>
      <th></th>
      <th>label</th>
      <th>area</th>
      <th>convex_area</th>
      <th>eccentricity</th>
      <th>solidity</th>
      <th>perimeter</th>
      <th>centroid-0</th>
      <th>centroid-1</th>
      <th>bbox-0</th>
      <th>bbox-1</th>
      <th>bbox-2</th>
      <th>bbox-3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2352</td>
      <td>2352</td>
      <td>0.20</td>
      <td>1.0</td>
      <td>190.0</td>
      <td>29</td>
      <td>202</td>
      <td>5</td>
      <td>179</td>
      <td>54</td>
      <td>227</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>2352</td>
      <td>2352</td>
      <td>0.20</td>
      <td>1.0</td>
      <td>190.0</td>
      <td>29</td>
      <td>422</td>
      <td>5</td>
      <td>399</td>
      <td>54</td>
      <td>447</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>272</td>
      <td>272</td>
      <td>0.34</td>
      <td>1.0</td>
      <td>62.0</td>
      <td>29</td>
      <td>139</td>
      <td>21</td>
      <td>132</td>
      <td>38</td>
      <td>148</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>272</td>
      <td>272</td>
      <td>0.34</td>
      <td>1.0</td>
      <td>62.0</td>
      <td>60</td>
      <td>92</td>
      <td>53</td>
      <td>84</td>
      <td>69</td>
      <td>101</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>2304</td>
      <td>2304</td>
      <td>0.00</td>
      <td>1.0</td>
      <td>188.0</td>
      <td>107</td>
      <td>29</td>
      <td>84</td>
      <td>6</td>
      <td>132</td>
      <td>54</td>
    </tr>
  </tbody>
</table>
</div>

<p>Fig. 6 illustrates the Felzenszwalb’s segmentation results over images containing simple geometric shapes. Little difference can be perceived from the edge-based segmentation strategy.
I used the parameters <code class="language-plaintext highlighter-rouge">scale=1e6, sigma=0.1, min_size=10</code> to detect the simple geometric shapes, which enforces large objects (high <code class="language-plaintext highlighter-rouge">scale</code>) and low Gaussian filtering (low <code class="language-plaintext highlighter-rouge">sigma</code>). Decreasing <code class="language-plaintext highlighter-rouge">scale</code> had little influence in the results of the last sample (containing 9 objects). However, this resulted in an incorrect segmentation for the objects in the first and second images, in which the objects and their borders were being classified as distinct coinciding objects.
I found <code class="language-plaintext highlighter-rouge">min_size</code> to be of little importance in these examples, as it is applied as a post-processing stage and can be disregarded when <code class="language-plaintext highlighter-rouge">scale</code> is sufficiently large.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot_all_segments</span><span class="p">(</span><span class="n">grays</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_20_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Segmentation of the objects in the three original images using the Felzenszwalb's method.
  </figcaption>


  </figure>
</div>

<p>Similar results are obtained with Felzenszwalb, with respect to the area of objects:</p>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_20_1.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Histograms of areas detected from objects in each scenario.
  </figcaption>


  </figure>
</div>

<h2 id="bccd-dataset">BCCD Dataset</h2>

<p>To demonstrate in a more realistic scenario, I opted to use the <a href="https://www.tensorflow.org/datasets/catalog/bccd">BCCD Dataset</a>.
This set comprises small-scale image samples used for blood cell detection.</p>

<div class="text-center mb-1" style="height:1.25rem">
  <hr class="thin mb-0 border-1 sr-none " />
  <button data-bs-target="#cv2" aria-controls="cv2" class="btn rounded-5 btn-light" style="position: relative; margin-top: -2rem;" type="button" data-bs-toggle="collapse" aria-expanded="false">show collapsed</button>
</div>

<div class="language-python collapse highlighter-rouge" id="cv2"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="n">tfds</span>

<span class="p">(</span><span class="n">train</span><span class="p">,),</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s">'bccd'</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="p">[</span><span class="s">'train'</span><span class="p">],</span> <span class="n">with_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">shuffle_files</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">int2str</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">features</span><span class="p">[</span><span class="s">'objects'</span><span class="p">][</span><span class="s">'label'</span><span class="p">].</span><span class="n">int2str</span>

<span class="n">bccd_samples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">train</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">bccd_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s">'image'</span><span class="p">].</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bccd_samples</span><span class="p">]</span>
<span class="n">bccd_grays</span> <span class="o">=</span> <span class="p">[</span><span class="n">skimage</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">rgb2gray</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bccd_images</span><span class="p">]</span>
<span class="n">bccd_cells</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s">'objects'</span><span class="p">][</span><span class="s">'label'</span><span class="p">].</span><span class="n">shape</span><span class="p">.</span><span class="n">as_list</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">bccd_samples</span><span class="p">],</span> <span class="p">[])</span>


<span class="n">fig</span> <span class="o">=</span> <span class="n">visualize</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="s">'image'</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bccd_samples</span><span class="p">],</span> <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">get_axes</span><span class="p">()</span>

<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">bccd_samples</span><span class="p">):</span>
    <span class="n">plot_detection_boxes</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
</code></pre></div></div>

<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_22_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    A few samples from the BCCD dataset. Cells are annotated in RBC (red blood cells), WBC (white blood cells) and Platelets.
  </figcaption>


  </figure>
</div>

<h3 id="segmentation-using-felzenszwalbs-method-1">Segmentation using Felzenszwalb’s Method</h3>
<p>Edge-detection methods produce poor results over samples in the BCCD dataset, as they are quite more complex
than the ones previously used — presenting salt-and-pepper noise and much more densely distributed objects —.
Thus, I once again employed Felzenszwalb’s method.</p>

<p>We first “search” for the best combination of parameters to use in this set.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">ParameterGrid</span>

<span class="k">def</span> <span class="nf">search_felzenszwalb</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">13</span><span class="p">)):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">ParameterGrid</span><span class="p">({</span>
      <span class="s">'scale'</span><span class="p">:</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">],</span>
      <span class="s">'min_size'</span><span class="p">:</span> <span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">300</span><span class="p">],</span>
    <span class="p">})</span>

  <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">segment</span> <span class="o">=</span> <span class="n">skimage</span><span class="p">.</span><span class="n">segmentation</span><span class="p">.</span><span class="n">felzenszwalb</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">)</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">Config</span><span class="p">.</span><span class="n">properties</span><span class="p">))</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plot_segments</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">segment</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">((</span><span class="s">':'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">param</span><span class="p">.</span><span class="n">items</span><span class="p">())))</span>

  <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">search_felzenszwalb</span><span class="p">(</span><span class="n">bccd_images</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_25_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Effect of the parameters <code>scale</code> and <code>min_size</code> over segmentation.
  </figcaption>


  </figure>
</div>

<p>The segmentation results of samples in the BCCD dataset are shown in Fig. 10. The method has correctly segmented many of the blood cells in some samples (such as in the third and fifth images). However, a few drawbacks are noticeable as well: this method is strongly affected by small grains, and will often recognize small microorganisms that were captured by the microscope while photographing the blood cells. Furthermore, cells that were smashed together seem to have been classified as a single object (first and eighth images).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">images</span> <span class="o">=</span> <span class="n">bccd_images</span>

<span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">skimage</span><span class="p">.</span><span class="n">segmentation</span><span class="p">.</span><span class="n">felzenszwalb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
<span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">Config</span><span class="p">.</span><span class="n">properties</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>
</code></pre></div></div>

<div class="text-center mb-1" style="height:1.25rem">
  <hr class="thin mb-0 border-1 sr-none " />
  <button data-bs-target="#cv3" aria-controls="cv3" class="btn rounded-5 btn-light" style="position: relative; margin-top: -2rem;" type="button" data-bs-toggle="collapse" aria-expanded="false">show collapsed</button>
</div>

<div class="language-python collapse highlighter-rouge" id="cv3"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_all_segments_and_bboxes</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
  <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

  <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">props</span><span class="p">)):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plot_segments</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

  <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plot_all_segments_and_bboxes</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
</code></pre></div></div>

<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_28_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Segmentation results over samples in the BCCD dataset. 
  </figcaption>


  </figure>
</div>

<div class="text-center mb-1" style="height:1.25rem">
  <hr class="thin mb-0 border-1 sr-none " />
  <button data-bs-target="#cv4" aria-controls="cv4" class="btn rounded-5 btn-light" style="position: relative; margin-top: -2rem;" type="button" data-bs-toggle="collapse" aria-expanded="false">show collapsed</button>
</div>

<div class="language-python collapse highlighter-rouge" id="cv4"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">histogram_objects</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s">'area'</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

  <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">props</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">props</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">ix</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">prop</span><span class="p">[</span><span class="n">by</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">percentile</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">99</span><span class="p">)]</span>
    <span class="n">sns</span><span class="p">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

  <span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">histogram_objects</span><span class="p">(</span><span class="n">props</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">95</span><span class="p">)</span>
</code></pre></div></div>

<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_29_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Histogram of areas detected from objects in samples in the BCCD dataset.
  </figcaption>


  </figure>
</div>

<p>Finally, Felzenszwalb’s method will indistinguishably segment the background sections of the image into regions, as these sections also present color information. It is therefore necessary to employ heuristics that discriminate foreground/background in order to separate it.</p>

<h4 id="post-processing-filtering-objects-by-overall-size">Post-Processing: Filtering Objects by Overall Size</h4>

<p>To remedy the grain noise being detected by Felzenszwalb’s, we can sub-select objects based on their properties.
A simple selection could be defined by its overall area:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">RBC_AREA</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e3</span><span class="p">,</span> <span class="mf">2e4</span><span class="p">)</span>

<span class="n">props_rbc</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[(</span><span class="n">p</span><span class="p">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="n">RBC_AREA</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">RBC_AREA</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">props</span><span class="p">]</span>
<span class="n">segments_rbc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">isin</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">props_rbc</span><span class="p">)]</span>

<span class="n">plot_all_segments_and_bboxes</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">bccd_samples</span><span class="p">,</span> <span class="n">segments_rbc</span><span class="p">,</span> <span class="n">props_rbc</span><span class="p">)</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_31_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Segmentation results over samples in the BCCD dataset. Only objects with area between $1e3$ and $2e4$ are shown.
  </figcaption>


  </figure>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">histogram_objects</span><span class="p">(</span><span class="n">props_rbc</span><span class="p">)</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_32_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Histogram of areas detected from objects in the samples in the BCCD dataset. Only objects with area between $1e3$ and $2e4$ account for this statistics.
  </figcaption>


  </figure>
</div>

<h4 id="pre-processing-filtering-noise">Pre-Processing: Filtering Noise</h4>

<p>The noise present in the samples correspond to dirt present in the lab sample, and do not contribute to the detection of blood cells.
We can use <a href="https://scikit-image.org/docs/dev/api/skimage.filters.rank.html#skimage.filters.rank.mean_bilateral">filters.rank.mean_bilateral</a>
to remove this noise before applying segmentation, possibly reducing the complexity and helping Felzenszwalb’s to focus on the cells:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">color</span><span class="p">,</span> <span class="n">img_as_ubyte</span><span class="p">,</span> <span class="n">img_as_float</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">disk</span>
<span class="kn">from</span> <span class="nn">skimage.filters.rank</span> <span class="kn">import</span> <span class="n">mean_bilateral</span>

<span class="n">selem20</span> <span class="o">=</span> <span class="n">disk</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mean_bilateral_fn</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">selem</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">s1</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">color</span><span class="p">.</span><span class="n">rgb2gray</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">img_as_ubyte</span><span class="p">(</span><span class="n">image</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint16'</span><span class="p">)</span>
  <span class="n">image</span> <span class="o">=</span> <span class="n">mean_bilateral</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">selem</span><span class="p">,</span> <span class="n">s0</span><span class="o">=</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="o">=</span><span class="n">s1</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">image</span> <span class="o">/</span> <span class="mf">255.</span>

<span class="n">grays_bilateral</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_bilateral_fn</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">selem20</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

<span class="n">visualize</span><span class="p">(</span><span class="n">grays</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="n">grays_bilateral</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_36_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Application of the <code>mean_bilateral</code>. From top to bottom: (a) the original samples in the BCCD dataset, (b) the corresponding sample cleaned from noise.
  </figcaption>


  </figure>
</div>

<p>Fig. 14 illustrates the application of <code class="language-plaintext highlighter-rouge">mean_bilateral</code> over samples in the BCCD dataset.
We observe that much of the noise is either removed or attenuated.</p>

<p>As samples have changed drastically, we search parameters once again. Fig. 15 illustrates
the effect of varying <code class="language-plaintext highlighter-rouge">scale</code> and <code class="language-plaintext highlighter-rouge">min_size</code> over a sample in the BCCD dataset. The combination
<code class="language-plaintext highlighter-rouge">scale=1e4</code> and <code class="language-plaintext highlighter-rouge">min_size=150</code> seems to produce reasonable results for this sample.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">search_felzenszwalb</span><span class="p">(</span><span class="n">grays_bilateral</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_37_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Effect of the parameters <code>scale</code> and <code>min_size</code> over segmentation, after preprocessing with <code>mean_bilateral</code> was performed.
  </figcaption>


  </figure>
</div>

<p>We can now apply to each sample in our subset:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Pre-processing
</span><span class="n">selem20</span> <span class="o">=</span> <span class="n">disk</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">grays_bilateral</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_bilateral_fn</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">selem20</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

<span class="c1"># Segmentation
</span><span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">skimage</span><span class="p">.</span><span class="n">segmentation</span><span class="p">.</span><span class="n">felzenszwalb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">grays_bilateral</span><span class="p">]</span>
<span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">Config</span><span class="p">.</span><span class="n">properties</span><span class="p">))</span>
         <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>

<span class="c1"># Post-processing
</span><span class="n">RBC_AREA</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e3</span><span class="p">,</span> <span class="mf">2e4</span><span class="p">)</span>

<span class="n">props_rbc</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[(</span><span class="n">p</span><span class="p">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="n">RBC_AREA</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">RBC_AREA</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">props</span><span class="p">]</span>
<span class="n">segments_rbc</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">isin</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">props_rbc</span><span class="p">)]</span>

<span class="n">plot_all_segments_and_bboxes</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">bccd_samples</span><span class="p">,</span> <span class="n">segments_rbc</span><span class="p">,</span> <span class="n">props_rbc</span><span class="p">)</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_40_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Segmentation results over samples BCCD dataset, preprocessing samples with <code>mean_bilateral</code> and post-processing them by sub-selecting objects within a reasonable overall area.
  </figcaption>


  </figure>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">histogram_objects</span><span class="p">(</span><span class="n">props_rbc</span><span class="p">)</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_41_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Histogram of areas for each image in the BCCD dataset.
  </figcaption>


  </figure>
</div>

<p>From Fig. 16 and Fig. 17 show our cleaned segmentation results.
The algorithm seems much more focused on cells now!</p>

<h3 id="morphological-boundaries">Morphological Boundaries</h3>

<p>Going in a different direction, morphology can also be used to segment objects in images. I employed a second segmentation strategy, which consists of applying the Ostu’s threshold [2] to separate objects from background and employ morphology to close small holes. The cleaned mask can then be labeled according to its connected regions.</p>

<p>The code below describes the necessary steps to implement this strategy. Notice that the binary mask that will serve as input to the morphological operations is created by retaining the positions in which pixel intensity is below the threshold (<code class="language-plaintext highlighter-rouge">image &lt; t</code>), as the objects in this problem present a lower pixel intensity than the background’s. This differs from the examples in scikit-image documentation, in which silver coins were being compared to a dark background.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">label</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">threshold_otsu</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">opening</span><span class="p">,</span> <span class="n">closing</span><span class="p">,</span> <span class="n">square</span>

<span class="k">def</span> <span class="nf">morphological_segmentation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">so</span><span class="o">=</span><span class="n">square</span><span class="p">(</span><span class="mi">5</span><span class="p">)):</span>
  <span class="n">bw</span> <span class="o">=</span> <span class="n">image</span> <span class="o">&lt;</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">label</span><span class="p">(</span><span class="n">opening</span><span class="p">(</span><span class="n">closing</span><span class="p">(</span><span class="n">bw</span><span class="p">,</span> <span class="n">so</span><span class="p">),</span>  <span class="n">so</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%%</span><span class="n">time</span>

<span class="n">images</span> <span class="o">=</span> <span class="n">bccd_grays</span>
<span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">morphological_segmentation</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
<span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">regionprops_table</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">Config</span><span class="p">.</span><span class="n">properties</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>
</code></pre></div></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CPU <span class="nb">times</span>: user 1.13 s, sys: 520 ms, total: 1.65 s
Wall <span class="nb">time</span>: 1.11 s
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot_all_segments_and_bboxes</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">bccd_samples</span><span class="p">,</span> <span class="n">segments</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_45_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Segmentation results over samples in the BCCD dataset using Morphological operators.
  </figcaption>


  </figure>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">histogram_objects</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
</code></pre></div></div>
<div style="" class="text-center">
  <figure class="figure ">
    <img src="/assets/images/posts/cv/segmentation/2021-07-16-segmentation_46_0.webp" alt="" class="figure-img img-fluid rounded mx-auto d-block w-100" />

    
  <figcaption class="figure-caption text-start">
    <strong class="title"></strong>

    Histograms of areas detected in objects in each image.
  </figcaption>


  </figure>
</div>

<p>The segmentation results over samples in the BCCD dataset are shown in Fig. 18 and Fig. 19. Through inspection, we notice this strategy is robust against small grains in the image, and correctly segments red blood cells presenting light-shaded interiors. It also automatically ignores the background and does not interpret its regions as new objects — through the usage of Otsu’s method <a class="citation" href="#otsu4310076">[4]</a> —. Notwithstanding, long cell chains (which are smashed against each other) are incorrectly segmented as a single object, regardless of their color differences (an effect observed in the first, second, third, fifth, ninth and tenth images).</p>

<h2 id="references">References</h2>

<ol class="bibliography"><li><span id="torre4767769">V. Torre and T. A. Poggio, “On Edge Detection,” <i>IEEE Transactions on Pattern Analysis and Machine Intelligence</i>, vol. PAMI-8, no. 2, pp. 147–163, 1986, doi: 10.1109/TPAMI.1986.4767769.</span></li>
<li><span id="strahler1957quantitative">A. N. Strahler, “Quantitative analysis of watershed geomorphology,” <i>Eos, Transactions American Geophysical Union</i>, vol. 38, no. 6, pp. 913–920, 1957.</span></li>
<li><span id="felzenszwalb2004">P. F. Felzenszwalb and D. P. Huttenlocher, “Efficient Graph-Based Image Segmentation,” <i>International Journal of Computer Vision</i>, vol. 59, no. 2, pp. 167–181, Sep. 2004, doi: 10.1023/B:VISI.0000022288.19776.77.</span></li>
<li><span id="otsu4310076">N. Otsu, “A Threshold Selection Method from Gray-Level Histograms,” <i>IEEE Transactions on Systems, Man, and Cybernetics</i>, vol. 9, no. 1, pp. 62–66, 1979, doi: 10.1109/TSMC.1979.4310076.</span></li></ol>

        </div>
      </article>

      
      <div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://lucasdavid-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      
    </div>
  </div>
</div>
<div class="empty-v-space d-none d-xl-block" style="margin-bottom: 10vh"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"
  integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"
  integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
  onload="renderMathInElement(document.body, {delimiters: [{left: '$$', right: '$$', display: true},{left: '\\[', right: '\\]', display: true}, {left: '$', right: '$', display: false},{left: '\\(', right: '\\)', display: false}]});"></script>

<script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>
<script>
  anchors.options = { icon: '#' };
  anchors.add();
</script>


  <!-- <svg id="visual" viewBox="0 0 1980 300"  class="curve-container__curve curve-three" xmlns="http://www.w3.org/2000/svg"
  xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
  <path
    d="M0 69L55 90.2C110 111.3 220 153.7 330 169.8C440 186 550 176 660 165.5C770 155 880 144 990 139.2C1100 134.3 1210 135.7 1320 137.7C1430 139.7 1540 142.3 1650 155.5C1760 168.7 1870 192.3 1925 204.2L1980 216L1980 301L1925 301C1870 301 1760 301 1650 301C1540 301 1430 301 1320 301C1210 301 1100 301 990 301C880 301 770 301 660 301C550 301 440 301 330 301C220 301 110 301 55 301L0 301Z"
    fill="#d3d3d3"></path>
  <path
    d="M0 89L55 107.8C110 126.7 220 164.3 330 191.3C440 218.3 550 234.7 660 243.8C770 253 880 255 990 252.3C1100 249.7 1210 242.3 1320 228.8C1430 215.3 1540 195.7 1650 174.5C1760 153.3 1870 130.7 1925 119.3L1980 108L1980 301L1925 301C1870 301 1760 301 1650 301C1540 301 1430 301 1320 301C1210 301 1100 301 990 301C880 301 770 301 660 301C550 301 440 301 330 301C220 301 110 301 55 301L0 301Z"
    fill="#6a6a6a"></path>
  <path
    d="M0 229L55 232.3C110 235.7 220 242.3 330 244.3C440 246.3 550 243.7 660 247.3C770 251 880 261 990 254.8C1100 248.7 1210 226.3 1320 223.5C1430 220.7 1540 237.3 1650 233.8C1760 230.3 1870 206.7 1925 194.8L1980 183L1980 301L1925 301C1870 301 1760 301 1650 301C1540 301 1430 301 1320 301C1210 301 1100 301 990 301C880 301 770 301 660 301C550 301 440 301 330 301C220 301 110 301 55 301L0 301Z"
    fill="#121212"></path>
</svg> -->
<footer class="page-footer text-bg-dark bg-black-subtle d-print-none">
  <div class="container">
    <div class="mt-4 mb-5">
      
        <div class="row g-1 mb-4">
          
          <div class="col">
            <div class="card bg-black-subtle border-0 border-start border-dark rounded-0">
              <div class="card-body font-small pt-0 pb-0">
                <h6 class="card-title fw-bold text-light">Keras Explainable</h6>
                <p class="card-text text-light">
                  Clean implementations for AI explaining methods in Keras.
<a href="https://github.com/lucasdavid/keras-explainable" target="_new">Code</a> and
<a href="https://lucasdavid.github.io/keras-explainable" target="_new">docs</a> are available.
                </p>
              </div>
            </div>
          </div>
          
          <div class="col">
            <div class="card bg-black-subtle border-0 border-start border-dark rounded-0">
              <div class="card-body font-small pt-0 pb-0">
                <h6 class="card-title fw-bold text-light">Supporting Study Material</h6>
                <p class="card-text text-light">
                  If you are an undergrad student and are looking for additional study material,
check out our collaborative project <a href="http://comp-ufscar.github.io/">comp-ufscar.github.io</a>.
                </p>
              </div>
            </div>
          </div>
          
          <div class="col">
            <div class="card bg-black-subtle border-0 border-start border-dark rounded-0">
              <div class="card-body font-small pt-0 pb-0">
                <h6 class="card-title fw-bold text-light">Algorithms in TensorFlow</h6>
                <p class="card-text text-light">
                  I'm implementing all algorithms I find interesting using TensorFlow.
You can check it out at <a href="https://github.com/lucasdavid/algorithms-in-tensorflow/">github.com/lucasdavid/algorithms-in-tensorflow</a>.
                </p>
              </div>
            </div>
          </div>
          
          <div class="col">
            <div class="card bg-black-subtle border-0 border-start border-dark rounded-0">
              <div class="card-body font-small pt-0 pb-0">
                <h6 class="card-title fw-bold text-light">TF-Experiment</h6>
                <p class="card-text text-light">
                  And environment to run Machine Learning experiments based on components and mixins. Available at <a href="https://github.com/lucasdavid/tf-experiment">github.com/lucasdavid/tf-experiment</a>.
                </p>
              </div>
            </div>
          </div>
          
          <div class="col">
            <div class="card bg-black-subtle border-0 border-start border-dark rounded-0">
              <div class="card-body font-small pt-0 pb-0">
                <h6 class="card-title fw-bold text-light">Mineração de Dados Complexos</h6>
                <p class="card-text text-light">
                  Information around the extension program "Mineração de Dados Complexos (in Portuguese)" is available at
<a href="https://www.ic.unicamp.br/~mdc/" target="_blank">ic.unicamp.br/~mdc/</a>.
                </p>
              </div>
            </div>
          </div>
          
        </div>
        
    </div>

    <div class="text-end mt-4">
      


<div class="fs-2">
  
    <a href="https://github.com/lucasdavid"
      target="_blank"
      ><i
      aria-label="GitHub"
      class="bi bi-github link-light"></i></a>
  
  
    <a href="https://www.linkedin.com/in/ld7"
      target="_blank"
      title="LinkedIn"><i class="bi bi-linkedin text-primary sr-none"></i></a>
  
  <span itemscope itemtype="https://schema.org/Person">
    <a itemprop="sameAs" content="https://orcid.org/0000-0002-8793-7300" href="https://orcid.org/0000-0002-8793-7300"
       target="orcid.widget"
       rel="me noopener noreferrer"
       title="ORCID"
      ><img src="/assets/images/infra/32px-ORCID_iD.webp" alt="ORCID logo" class="sr-none" style="margin-bottom: 7px; width: 32px;"></a>
  </span>
  
  <a href="http://stackoverflow.com/users/2429640/lucasdavid"
     target="_blank"
     title="Stackoverflow"><i class="bi bi-code-slash link-light sr-none"></i></a>
  
    <a href="https://youtube.com/channel/UC7IWeKUy4OSlC5ripcQGD6Q"
      target="_blank"
      title="Youtube"><i class="bi bi-youtube text-danger sr-none"></i></a>
  
    <a href="mailto:mb37410l3@mozmail.com"
      target="_blank"
      title="Mail"><i class="bi bi-envelope-fill link-light sr-none"></i></a>
  
  <a href="assets/docs/lucas-david-resume.pdf"
     target="_blank"
     title="Resume"><i class="bi bi-person-lines-fill link-light sr-none"></i></a>
</div>

    </div>
    <div class="text-end">
      <p>
        ® Lucas David. Todos os direitos reservados.
      </p>
    </div>
</div>
</footer>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
    integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
    crossorigin="anonymous" defer></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
    integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
    crossorigin="anonymous" defer></script>

</body>
</html>
